<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Arbitration Platform</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öñÔ∏è</text></svg>" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.0/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/fhevmjs@0.5.0/bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #eee;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(30, 30, 46, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.3);
            border-color: rgba(0, 212, 255, 0.5);
        }

        .card h3 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #00d4ff;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: rgba(0, 0, 0, 0.3);
            color: #eee;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(0, 0, 0, 0.5);
        }

        .btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.6);
            background: linear-gradient(135deg, #00ffff 0%, #00d4ff 100%);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-card {
            background: rgba(0, 0, 0, 0.4);
            border-left: 4px solid #00d4ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .dispute-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
        }

        .dispute-item.in-progress {
            border-left-color: #ffaa00;
        }

        .dispute-item.resolved {
            border-left-color: #00ff88;
        }

        .error {
            color: #ff6b6b;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #ff6b6b;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .info {
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .wallet-status {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-item {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .network-info {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîí Anonymous Arbitration Platform</h1>
            <p>Privacy-Preserving Dispute Resolution Using Zero-Knowledge Cryptography</p>

            <!-- Network Information -->
            <div class="network-info" id="networkInfo">
                Network: Not Connected | Required: Sepolia Testnet (Chain ID: 11155111)
            </div>

            <!-- Wallet Connection Status -->
            <div class="wallet-status">
                <div id="walletStatus">
                    <button id="connectWallet" class="btn">Connect Wallet</button>
                </div>
            </div>

            <!-- Platform Statistics -->
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="totalDisputes">0</span>
                    <div class="stat-label">Total Disputes</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="activeArbitrators">0</span>
                    <div class="stat-label">Active Arbitrators</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="resolvedDisputes">0</span>
                    <div class="stat-label">Resolved Cases</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="userReputation">0</span>
                    <div class="stat-label">Your Reputation</div>
                </div>
            </div>
        </div>

        <!-- Contract Deployment Notice -->
        <div class="card" id="deploymentNotice">
            <h3>üöÄ Contract Deployment Required</h3>
            <p><strong>To use this platform, you need to deploy the smart contract first:</strong></p>
            <ol>
                <li>Deploy the AnonymousArbitrationPlatform.sol contract to Sepolia testnet</li>
                <li>Update the CONTRACT_ADDRESS variable in this file with your deployed contract address</li>
                <li>Make sure you have Sepolia testnet ETH for transactions</li>
            </ol>
            <p><strong>Contract Location:</strong> /contracts/AnonymousArbitrationPlatform.sol</p>
            <div class="info">
                <strong>Note:</strong> This is a production-ready frontend that requires a real deployed contract on Sepolia testnet.
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-content">
            <!-- Arbitrator Registration -->
            <div class="card">
                <h3>üéñÔ∏è Become an Arbitrator</h3>
                <div class="input-group">
                    <label for="identityProof">Identity Verification Code:</label>
                    <input type="number" id="identityProof" placeholder="Enter verification code">
                </div>
                <button class="btn" id="registerArbitratorBtn">Register as Arbitrator</button>
                <div id="arbitratorStatus" class="status-card hidden">
                    <h4>Arbitrator Status</h4>
                    <p>Reputation: <span id="arbitratorReputation">0</span></p>
                    <p>Cases Handled: <span id="casesHandled">0</span></p>
                    <p>Success Rate: <span id="successRate">0%</span></p>
                </div>
            </div>

            <!-- Create New Dispute -->
            <div class="card">
                <h3>‚öñÔ∏è File New Dispute</h3>
                <div class="input-group">
                    <label for="defendantAddress">Defendant Address:</label>
                    <input type="text" id="defendantAddress" placeholder="0x...">
                </div>
                <div class="input-group">
                    <label for="stakeAmount">Stake Amount (ETH):</label>
                    <input type="number" id="stakeAmount" step="0.001" min="0.001" value="0.001">
                </div>
                <div class="input-group">
                    <label for="evidenceHash">Evidence Hash:</label>
                    <input type="number" id="evidenceHash" placeholder="Numeric hash of evidence">
                </div>
                <div class="input-group">
                    <label for="disputeDescription">Dispute Description (Optional):</label>
                    <textarea id="disputeDescription" rows="3" placeholder="Brief description of the dispute..."></textarea>
                </div>
                <button class="btn" id="createDisputeBtn">Create Dispute</button>
            </div>

            <!-- Dispute Management -->
            <div class="card">
                <h3>üìã Manage Disputes</h3>
                <div class="input-group">
                    <label for="disputeId">Dispute ID:</label>
                    <input type="number" id="disputeId" placeholder="Enter dispute ID">
                </div>
                <button class="btn" id="assignArbitratorsBtn">Assign Arbitrators</button>
                <button class="btn" id="getDisputeInfoBtn">Get Dispute Info</button>

                <div id="disputeInfo" class="status-card hidden">
                    <h4>Dispute Information</h4>
                    <div id="disputeDetails"></div>
                </div>
            </div>

            <!-- Voting Interface -->
            <div class="card">
                <h3>üó≥Ô∏è Cast Your Vote</h3>
                <div class="input-group">
                    <label for="voteDisputeId">Dispute ID:</label>
                    <input type="number" id="voteDisputeId" placeholder="Enter dispute ID">
                </div>
                <div class="input-group">
                    <label for="voteOption">Your Decision:</label>
                    <select id="voteOption">
                        <option value="">Select your vote</option>
                        <option value="1">Favor Plaintiff</option>
                        <option value="2">Favor Defendant</option>
                        <option value="3">Neutral/Inconclusive</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="justification">Justification Code:</label>
                    <input type="number" id="justification" placeholder="Numeric justification code">
                </div>
                <button class="btn" id="submitVoteBtn">Submit Vote</button>
            </div>

            <!-- Active Disputes -->
            <div class="card">
                <h3>üîç Active Disputes</h3>
                <button class="btn" id="loadDisputesBtn">Load My Disputes</button>
                <div id="disputesList" class="status-card">
                    <p>Click "Load My Disputes" to see your active cases</p>
                </div>
            </div>

            <!-- Platform Analytics -->
            <div class="card">
                <h3>üìä Platform Analytics</h3>
                <div class="input-group">
                    <label for="userAddress">User Address (Optional):</label>
                    <input type="text" id="userAddress" placeholder="Check specific user reputation">
                </div>
                <button class="btn" id="getUserReputationBtn">Check Reputation</button>
                <button class="btn" id="refreshStatsBtn">Refresh Statistics</button>

                <div id="userStats" class="status-card hidden">
                    <h4>User Statistics</h4>
                    <div id="userStatsDetails"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="card" style="text-align: center; margin-top: 40px;">
            <h3>üîê Privacy & Security Features</h3>
            <p><strong>‚úì Encrypted Evidence:</strong> All dispute evidence is encrypted using FHE</p>
            <p><strong>‚úì Anonymous Voting:</strong> Arbitrator votes remain private until resolution</p>
            <p><strong>‚úì Identity Protection:</strong> Participant identities are cryptographically protected</p>
            <p><strong>‚úì Fair Selection:</strong> Random arbitrator assignment ensures impartiality</p>
            <p><strong>‚úì Reputation System:</strong> Built-in reputation tracking for quality assurance</p>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <script>
        // Contract configuration - UPDATE WITH YOUR DEPLOYED CONTRACT ADDRESS
        const CONTRACT_ADDRESS = "0x019487001FaCC26883f8760b72B0DAef2cbFa1bd"; // REPLACE WITH ACTUAL DEPLOYED ADDRESS
        const REQUIRED_CHAIN_ID = 11155111; // Sepolia testnet
        const REQUIRED_NETWORK_NAME = "Sepolia";

        const CONTRACT_ABI = [
            "function registerArbitrator(uint32 _identityProof) external",
            "function createDispute(address _defendant, uint32 _stakeAmount, uint32 _evidenceHash) external payable",
            "function assignArbitrators(uint256 _disputeId) external",
            "function submitVote(uint256 _disputeId, uint8 _vote, uint32 _justification) external",
            "function getDisputeInfo(uint256 _disputeId) external view returns (address, address, uint8, uint256, uint256, uint256, bool, address)",
            "function getArbitratorInfo(address _arbitrator) external view returns (bool, uint256, uint256, uint256, bool)",
            "function getUserReputation(address _user) external view returns (uint256)",
            "function disputeCounter() external view returns (uint256)",
            "function arbitratorPool() external view returns (uint256)",
            "event DisputeCreated(uint256 indexed disputeId, address indexed plaintiff, address indexed defendant)",
            "event ArbitratorsAssigned(uint256 indexed disputeId, address[] arbitrators)",
            "event VoteSubmitted(uint256 indexed disputeId, address indexed arbitrator)",
            "event DisputeResolved(uint256 indexed disputeId, address indexed winner)",
            "event ArbitratorRegistered(address indexed arbitrator)"
        ];

        let provider, signer, contract, userAddress, currentChainId;

        // Initialize the application
        async function init() {
            console.log("Initializing Anonymous Arbitration Platform...");

            // Check if ethers is loaded
            if (typeof ethers === 'undefined') {
                showMessage("Ethers.js library failed to load. Please refresh the page.", "error");
                return;
            }
            console.log("Ethers.js version:", ethers.version);

            // Check if contract address is configured
            if (CONTRACT_ADDRESS === "0x0000000000000000000000000000000000000000") {
                showMessage("Contract not deployed yet. Please deploy the contract and update CONTRACT_ADDRESS.", "error");
                console.log("Note: You can still test wallet connection even without a deployed contract.");
            }

            // Set up event listeners
            setupEventListeners();

            // Update UI
            updateWalletStatus();
            updateNetworkInfo();

            // Check for existing connection
            if (window.ethereum) {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet(false);
                }
            }
        }

        // Connect wallet
        async function connectWallet(requestAccounts = true) {
            try {
                console.log("Attempting to connect wallet...");

                if (!window.ethereum) {
                    showMessage("Please install MetaMask!", "error");
                    return;
                }

                console.log("MetaMask detected, requesting accounts...");

                if (requestAccounts) {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                }

                console.log("Creating ethers provider...");
                provider = new ethers.BrowserProvider(window.ethereum);

                console.log("Getting signer...");
                signer = await provider.getSigner();

                console.log("Getting address...");
                userAddress = await signer.getAddress();

                // Check network
                const network = await provider.getNetwork();
                currentChainId = Number(network.chainId);

                if (currentChainId !== REQUIRED_CHAIN_ID) {
                    showMessage(`Please switch to ${REQUIRED_NETWORK_NAME} testnet (Chain ID: ${REQUIRED_CHAIN_ID})`, "error");
                    await switchToSepoliaNetwork();
                    return;
                }

                console.log("Wallet connected successfully!");
                console.log("Address:", userAddress);
                console.log("Chain ID:", currentChainId);

                // Initialize contract only if address is configured
                if (CONTRACT_ADDRESS !== "0x0000000000000000000000000000000000000000") {
                    console.log("Initializing contract...");
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    console.log("Contract initialized");
                } else {
                    console.log("Contract address not configured, skipping contract initialization");
                }

                updateWalletStatus();
                updateNetworkInfo();

                // Only load stats if contract is available
                if (contract) {
                    loadUserStats();
                    loadPlatformStats();
                }

                showMessage("Wallet connected successfully!", "success");

            } catch (error) {
                console.error("Wallet connection failed:", error);
                console.error("Error details:", error);

                let errorMessage = "Failed to connect wallet: ";
                if (error.code === 4001) {
                    errorMessage += "User rejected the connection request";
                } else if (error.code === -32002) {
                    errorMessage += "Connection request already pending";
                } else {
                    errorMessage += error.message || "Unknown error";
                }

                showMessage(errorMessage, "error");
            }
        }

        // Switch to Sepolia network
        async function switchToSepoliaNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x' + REQUIRED_CHAIN_ID.toString(16) }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x' + REQUIRED_CHAIN_ID.toString(16),
                                chainName: 'Sepolia test network',
                                rpcUrls: ['https://sepolia.infura.io/v3/'],
                                nativeCurrency: {
                                    name: 'Ethereum',
                                    symbol: 'ETH',
                                    decimals: 18,
                                },
                                blockExplorerUrls: ['https://sepolia.etherscan.io/'],
                            }],
                        });
                    } catch (addError) {
                        showMessage("Failed to add Sepolia network", "error");
                    }
                }
            }
        }

        // Update network information
        function updateNetworkInfo() {
            const networkDiv = document.getElementById('networkInfo');
            if (currentChainId) {
                const isCorrectNetwork = currentChainId === REQUIRED_CHAIN_ID;
                networkDiv.innerHTML = `
                    Network: Chain ID ${currentChainId} ${isCorrectNetwork ? '‚úÖ' : '‚ùå'} |
                    Required: ${REQUIRED_NETWORK_NAME} (Chain ID: ${REQUIRED_CHAIN_ID})
                `;
                networkDiv.style.background = isCorrectNetwork ? 'rgba(40, 167, 69, 0.3)' : 'rgba(220, 53, 69, 0.3)';
            }
        }

        // Update wallet connection status
        function updateWalletStatus() {
            const statusDiv = document.getElementById('walletStatus');
            if (userAddress) {
                statusDiv.innerHTML = `
                    <div style="color: #28a745; font-weight: bold;">
                        ‚úÖ Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}
                    </div>
                    <button class="btn" onclick="disconnectWallet()" style="margin-top: 10px; background: #dc3545;">
                        Disconnect
                    </button>
                `;
            } else {
                statusDiv.innerHTML = '<button id="connectWallet" class="btn">Connect Wallet</button>';
                document.getElementById('connectWallet').onclick = () => connectWallet(true);
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            provider = null;
            signer = null;
            contract = null;
            userAddress = null;
            currentChainId = null;
            updateWalletStatus();
            updateNetworkInfo();
            showMessage("Wallet disconnected", "info");
        }

        // Load platform statistics
        async function loadPlatformStats() {
            if (!contract) return;

            try {
                const totalDisputes = await contract.disputeCounter();
                const activeArbitrators = await contract.arbitratorPool();

                document.getElementById('totalDisputes').textContent = totalDisputes.toString();
                document.getElementById('activeArbitrators').textContent = activeArbitrators.toString();

                // Calculate resolved disputes (simplified)
                let resolvedCount = 0;
                for (let i = 1; i <= Math.min(Number(totalDisputes), 10); i++) {
                    try {
                        const disputeInfo = await contract.getDisputeInfo(i);
                        if (disputeInfo[6]) { // decisionRevealed
                            resolvedCount++;
                        }
                    } catch (error) {
                        // Dispute might not exist or be accessible
                    }
                }
                document.getElementById('resolvedDisputes').textContent = resolvedCount.toString();

            } catch (error) {
                console.error("Failed to load platform stats:", error);
            }
        }

        // Register as arbitrator
        async function registerArbitrator() {
            if (!contract) {
                showMessage("Please connect your wallet first", "error");
                return;
            }

            if (currentChainId !== REQUIRED_CHAIN_ID) {
                showMessage(`Please switch to ${REQUIRED_NETWORK_NAME} testnet`, "error");
                return;
            }

            const identityProof = document.getElementById('identityProof').value;
            if (!identityProof) {
                showMessage("Please enter identity verification code", "error");
                return;
            }

            try {
                showLoading('registerArbitratorBtn');
                const tx = await contract.registerArbitrator(parseInt(identityProof));
                showMessage("Transaction submitted. Waiting for confirmation...", "info");
                await tx.wait();
                showMessage("Successfully registered as arbitrator!", "success");
                loadArbitratorStatus();
                loadPlatformStats();
            } catch (error) {
                console.error("Registration failed:", error);
                showMessage("Registration failed: " + (error.reason || error.message), "error");
            } finally {
                hideLoading('registerArbitratorBtn');
            }
        }

        // Create dispute
        async function createDispute() {
            if (!contract) {
                showMessage("Please connect your wallet first", "error");
                return;
            }

            if (currentChainId !== REQUIRED_CHAIN_ID) {
                showMessage(`Please switch to ${REQUIRED_NETWORK_NAME} testnet`, "error");
                return;
            }

            const defendant = document.getElementById('defendantAddress').value;
            const stakeAmount = document.getElementById('stakeAmount').value;
            const evidenceHash = document.getElementById('evidenceHash').value;

            if (!defendant || !stakeAmount || !evidenceHash) {
                showMessage("Please fill all required fields", "error");
                return;
            }

            if (!ethers.isAddress(defendant)) {
                showMessage("Please enter a valid defendant address", "error");
                return;
            }

            try {
                showLoading('createDisputeBtn');
                const stakeWei = ethers.parseEther(stakeAmount);

                const tx = await contract.createDispute(
                    defendant,
                    parseInt(evidenceHash) % (2**32), // Ensure uint32 range
                    parseInt(evidenceHash) % (2**32),
                    { value: stakeWei }
                );

                showMessage("Transaction submitted. Waiting for confirmation...", "info");
                await tx.wait();
                showMessage("Dispute created successfully!", "success");
                clearForm(['defendantAddress', 'stakeAmount', 'evidenceHash', 'disputeDescription']);
                loadPlatformStats();
            } catch (error) {
                console.error("Failed to create dispute:", error);
                showMessage("Failed to create dispute: " + (error.reason || error.message), "error");
            } finally {
                hideLoading('createDisputeBtn');
            }
        }

        // Assign arbitrators
        async function assignArbitrators() {
            if (!contract) {
                showMessage("Please connect your wallet first", "error");
                return;
            }

            if (currentChainId !== REQUIRED_CHAIN_ID) {
                showMessage(`Please switch to ${REQUIRED_NETWORK_NAME} testnet`, "error");
                return;
            }

            const disputeId = document.getElementById('disputeId').value;
            if (!disputeId) {
                showMessage("Please enter dispute ID", "error");
                return;
            }

            try {
                showLoading('assignArbitratorsBtn');
                const tx = await contract.assignArbitrators(parseInt(disputeId));
                showMessage("Transaction submitted. Waiting for confirmation...", "info");
                await tx.wait();
                showMessage("Arbitrators assigned successfully!", "success");
            } catch (error) {
                console.error("Failed to assign arbitrators:", error);
                showMessage("Failed to assign arbitrators: " + (error.reason || error.message), "error");
            } finally {
                hideLoading('assignArbitratorsBtn');
            }
        }

        // Submit vote
        async function submitVote() {
            if (!contract) {
                showMessage("Please connect your wallet first", "error");
                return;
            }

            if (currentChainId !== REQUIRED_CHAIN_ID) {
                showMessage(`Please switch to ${REQUIRED_NETWORK_NAME} testnet`, "error");
                return;
            }

            const disputeId = document.getElementById('voteDisputeId').value;
            const vote = document.getElementById('voteOption').value;
            const justification = document.getElementById('justification').value;

            if (!disputeId || !vote || !justification) {
                showMessage("Please fill all fields", "error");
                return;
            }

            try {
                showLoading('submitVoteBtn');
                const tx = await contract.submitVote(
                    parseInt(disputeId),
                    parseInt(vote),
                    parseInt(justification) % (2**32)
                );
                showMessage("Transaction submitted. Waiting for confirmation...", "info");
                await tx.wait();
                showMessage("Vote submitted successfully!", "success");
                clearForm(['voteDisputeId', 'voteOption', 'justification']);
            } catch (error) {
                console.error("Failed to submit vote:", error);
                showMessage("Failed to submit vote: " + (error.reason || error.message), "error");
            } finally {
                hideLoading('submitVoteBtn');
            }
        }

        // Get dispute information
        async function getDisputeInfo() {
            if (!contract) {
                showMessage("Please connect your wallet first", "error");
                return;
            }

            const disputeId = document.getElementById('disputeId').value;
            if (!disputeId) {
                showMessage("Please enter dispute ID", "error");
                return;
            }

            try {
                showLoading('getDisputeInfoBtn');
                const info = await contract.getDisputeInfo(parseInt(disputeId));

                const statusNames = ['Created', 'InArbitration', 'Voting', 'Resolved', 'Cancelled'];

                document.getElementById('disputeInfo').classList.remove('hidden');
                document.getElementById('disputeDetails').innerHTML = `
                    <p><strong>Plaintiff:</strong> ${info[0]}</p>
                    <p><strong>Defendant:</strong> ${info[1]}</p>
                    <p><strong>Status:</strong> ${statusNames[info[2]] || 'Unknown'}</p>
                    <p><strong>Created:</strong> ${new Date(Number(info[3]) * 1000).toLocaleString()}</p>
                    <p><strong>Voting Deadline:</strong> ${Number(info[4]) > 0 ? new Date(Number(info[4]) * 1000).toLocaleString() : 'Not set'}</p>
                    <p><strong>Arbitrators:</strong> ${info[5]}</p>
                    <p><strong>Decision Revealed:</strong> ${info[6] ? 'Yes' : 'No'}</p>
                    <p><strong>Winner:</strong> ${info[7] === '0x0000000000000000000000000000000000000000' ? 'Not decided' : info[7]}</p>
                `;
            } catch (error) {
                console.error("Failed to get dispute info:", error);
                showMessage("Failed to get dispute info: " + (error.reason || error.message), "error");
            } finally {
                hideLoading('getDisputeInfoBtn');
            }
        }

        // Load arbitrator status
        async function loadArbitratorStatus() {
            if (!contract || !userAddress) return;

            try {
                const info = await contract.getArbitratorInfo(userAddress);
                if (info[0]) { // isActive
                    document.getElementById('arbitratorStatus').classList.remove('hidden');
                    document.getElementById('arbitratorReputation').textContent = info[1].toString();
                    document.getElementById('casesHandled').textContent = info[2].toString();
                    const successRate = Number(info[2]) > 0 ? ((Number(info[3]) / Number(info[2])) * 100).toFixed(1) : 0;
                    document.getElementById('successRate').textContent = successRate + '%';
                }
            } catch (error) {
                console.error("Failed to load arbitrator status:", error);
            }
        }

        // Load user statistics
        async function loadUserStats() {
            if (!contract || !userAddress) return;

            try {
                const reputation = await contract.getUserReputation(userAddress);
                document.getElementById('userReputation').textContent = reputation.toString();

                // Load arbitrator status if applicable
                loadArbitratorStatus();
            } catch (error) {
                console.error("Failed to load user stats:", error);
            }
        }

        // Check user reputation
        async function checkUserReputation() {
            if (!contract) {
                showMessage("Please connect your wallet first", "error");
                return;
            }

            const userAddressInput = document.getElementById('userAddress').value || userAddress;
            if (!userAddressInput) {
                showMessage("Please enter a user address or connect wallet", "error");
                return;
            }

            if (!ethers.isAddress(userAddressInput)) {
                showMessage("Please enter a valid address", "error");
                return;
            }

            try {
                const reputation = await contract.getUserReputation(userAddressInput);
                const arbitratorInfo = await contract.getArbitratorInfo(userAddressInput);

                document.getElementById('userStats').classList.remove('hidden');
                document.getElementById('userStatsDetails').innerHTML = `
                    <p><strong>Address:</strong> ${userAddressInput}</p>
                    <p><strong>Reputation:</strong> ${reputation.toString()}</p>
                    <p><strong>Is Arbitrator:</strong> ${arbitratorInfo[0] ? 'Yes' : 'No'}</p>
                    ${arbitratorInfo[0] ? `
                        <p><strong>Arbitrator Reputation:</strong> ${arbitratorInfo[1]}</p>
                        <p><strong>Cases Handled:</strong> ${arbitratorInfo[2]}</p>
                        <p><strong>Successful Cases:</strong> ${arbitratorInfo[3]}</p>
                        <p><strong>Identity Verified:</strong> ${arbitratorInfo[4] ? 'Yes' : 'No'}</p>
                    ` : ''}
                `;
            } catch (error) {
                console.error("Failed to check user reputation:", error);
                showMessage("Failed to check user reputation: " + (error.reason || error.message), "error");
            }
        }

        // Utility functions
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                margin: 10px 0;
                padding: 15px;
                border-radius: 5px;
                position: relative;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;

            const container = document.getElementById('messageContainer');
            container.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 8000);
        }

        function showLoading(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = true;
                button.innerHTML = '<div class="loading"></div>Processing...';
            }
        }

        function hideLoading(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = false;

                // Restore original button text based on ID
                const buttonTexts = {
                    'registerArbitratorBtn': 'Register as Arbitrator',
                    'createDisputeBtn': 'Create Dispute',
                    'assignArbitratorsBtn': 'Assign Arbitrators',
                    'submitVoteBtn': 'Submit Vote',
                    'getDisputeInfoBtn': 'Get Dispute Info'
                };

                if (buttonTexts[buttonId]) {
                    button.textContent = buttonTexts[buttonId];
                }
            }
        }

        function clearForm(fieldIds) {
            fieldIds.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('registerArbitratorBtn').onclick = registerArbitrator;
            document.getElementById('createDisputeBtn').onclick = createDispute;
            document.getElementById('assignArbitratorsBtn').onclick = assignArbitrators;
            document.getElementById('submitVoteBtn').onclick = submitVote;
            document.getElementById('getDisputeInfoBtn').onclick = getDisputeInfo;
            document.getElementById('getUserReputationBtn').onclick = checkUserReputation;
            document.getElementById('refreshStatsBtn').onclick = () => {
                loadUserStats();
                loadPlatformStats();
                showMessage("Statistics refreshed", "info");
            };
            document.getElementById('loadDisputesBtn').onclick = () => {
                showMessage("This feature requires additional contract queries. Check individual disputes by ID.", "info");
            };
        }

        // Initialize app when page loads
        window.addEventListener('load', init);

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    connectWallet(false);
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                currentChainId = parseInt(chainId, 16);
                updateNetworkInfo();
                if (currentChainId !== REQUIRED_CHAIN_ID) {
                    showMessage(`Please switch to ${REQUIRED_NETWORK_NAME} testnet`, "error");
                } else {
                    if (userAddress) {
                        connectWallet(false);
                    }
                }
            });
        }
    </script>
</body>
</html>